name: ç”Ÿæˆ Changelog å¹¶å‘å¸ƒç‰ˆæœ¬

on:
  workflow_call:
    inputs:
      run_id:
        required: true
        type: string
      build_type:
        description: "ç±»å‹ (Release/Nightly)"
        required: false
        default: "Release"
        type: string
      release_version:
        description: "å‘å¸ƒç‰ˆæœ¬å·"
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-changelog-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check Repository
        run: |
          if [ "${{ github.repository }}" != "Class-Widgets/Class-Widgets" ]; then
            echo "[DEBUG] å·¥ä½œæµä¸åœ¨ä¸»ä»“åº“"
            exit 1
          fi

      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Prepare release directory
        run: |
          mkdir -p release

      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: ClassWidgets-Packages
          path: artifacts
          run-id: ${{ inputs.run_id }}

      - name: Prepare artifacts for release
        shell: bash
        run: |
          if [ ! "$(ls -A artifacts 2>/dev/null)" ]; then
            exit 1
          fi
          find artifacts -name "*.zip" -type f -exec cp {} release/ \;
          if [ -f "artifacts/file_provenance.json" ]; then
            cp -f artifacts/file_provenance.json release/
          fi
          if [ ! "$(ls -A release 2>/dev/null)" ]; then
            exit 1
          fi
          echo "å‘å¸ƒçš„æ–‡ä»¶:"
          ls -la release/

      - name: Import GPG key
        if: ${{ inputs.release_version != '' }}
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_tag_gpgsign: true

      - name: Create Tag
        if: ${{ inputs.release_version != '' }}
        run: |
          tag_name="${{ inputs.release_version }}"
          echo "[DEBUG] åˆ›å»ºtag: $tag_name"
          if git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "[DEBUG] æ ‡ç­¾ $tag_name å·²å­˜åœ¨"
          else
            if [[ "${{ inputs.build_type }}" == "Nightly" ]]; then
              tag_message="Nightly $tag_name"
            else
              tag_message="Release $tag_name"
            fi
            git tag -s "$tag_name" -m "$tag_message"
            git push origin "$tag_name"
          fi

      - name: Clear Nightly-Builds
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_VERSION: ${{ inputs.release_version }}
        run: |
          echo "å½“å‰è¦å‘å¸ƒçš„ç‰ˆæœ¬: $CURRENT_VERSION"
          nightly_releases=$(gh release list --limit 4 --json tagName,name | jq -r '.[] | select(.tagName | contains("-nightly")) | .tagName' || true)
          if [ -z "$nightly_releases" ]; then
            echo "[DEBUG] æœªæ‰¾åˆ°æ—§çš„ nightly ç‰ˆæœ¬"
            exit 0
          fi
          echo "[DEBUG] æ‰¾åˆ°çš„ nightly ç‰ˆæœ¬:"
          echo "$nightly_releases"
          for release in $nightly_releases; do
            if [ "$release" != "$CURRENT_VERSION" ]; then
              echo "[DEBUG] åˆ é™¤æ—§ç‰ˆæœ¬: $release"
              gh release delete "$release" --yes --cleanup-tag || echo "[DEBUG] åˆ é™¤ $release æ—¶å¤±è´¥"
            else
              echo "[DEBUG] ä¿ç•™ç‰ˆæœ¬: $release"
            fi
          done

      - name: Set up git-cliff
        uses: kenji-miyake/setup-git-cliff@v2

      - name: Generate a changelog
        run: |
          if [[ "${{ inputs.build_type }}" == "Nightly" ]]; then
            git cliff --config .github/cliff.nightly.toml --latest --output CHANGELOG.md
          else
            git cliff --config .github/cliff.toml --latest --output CHANGELOG.md
          fi

      - name: Append file info to changelog
        shell: bash
        run: |
          if [ -f "artifacts/file-info.md" ]; then
            echo "" >> CHANGELOG.md
            echo "---" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat artifacts/file-info.md >> CHANGELOG.md
            echo "[DEBUG] å·²å°†åŒ…ä¿¡æ¯æ·»åŠ åˆ° Changelog"
            rm -f artifacts/file-info.md
          else
            echo "[DEBUG] æœªæ‰¾åˆ° file-info.md æ–‡ä»¶"
          fi

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_version || github.ref_name }}
          name: ${{ inputs.build_type == 'Nightly' && format('ğŸŒ™ Nightly Build {0}', inputs.release_version) || format('ğŸš€ Release {0}', inputs.release_version || github.ref_name) }}
          files: release/*
          body_path: CHANGELOG.md
          draft: ${{ inputs.build_type == 'Release' }}
          prerelease: ${{ inputs.build_type == 'Nightly' }}
          generate_release_notes: false
          make_latest: ${{ inputs.build_type == 'Release' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
