name: Verify PR

on:
  pull_request_target:
    types: [opened, edited]
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  branch-check:
    name: Validate PR branch
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        uses: tj-actions/branch-names@v9
        id: branch

      - name: Find branch comment
        if: steps.branch.outputs.head_ref_branch == 'main'
        uses: peter-evans/find-comment@v3
        id: find-branch-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'æ‚¨çš„ PR æ¥è‡ª`main`åˆ†æ”¯'

      - name: Comment on PR
        if: steps.branch.outputs.head_ref_branch == 'main' && steps.find-branch-comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âš ï¸ @${{ github.event.pull_request.user.login }} **å˜¿~æ‚¨çš„ PR æ¥è‡ª`main`åˆ†æ”¯ !**

            > [!WARNING]
            >  **åœ¨ `main` åˆ†æ”¯æäº¤çš„å†…å®¹å¯èƒ½è¢«å¼ºåˆ¶è¦†ç›–, å…ˆå¼€ä¸€ä¸ªåŠŸèƒ½åˆ†æ”¯å†æäº¤å§ âœ¨**
            >
            >> ğŸ“„[__*åˆ†æ”¯å‘½åæœ€ä½³å®è·µå‚è€ƒ*__](https://dev.to/jps27cse/github-branching-name-best-practices-49ei)

      - name: Validate PR title
        id: semantic-check
        uses: amannn/action-semantic-pull-request@v6
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find title comment
        uses: peter-evans/find-comment@v3
        id: find-title-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'PR æ ‡é¢˜æ ¼å¼ä¸è§„èŒƒ'

      - name: Comment on invalid PR title
        if: steps.semantic-check.outcome == 'failure' && steps.find-title-comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### @${{ github.event.pull_request.user.login }} **PR æ ‡é¢˜æ ¼å¼ä¸è§„èŒƒï¼**

            > [!TIP]
            > **æ‚¨çš„ PR æ ‡é¢˜ä¸ç¬¦åˆ Conventional Commits è§„èŒƒâœ¨**
            >
            >> ğŸ“„[__*è¯­ä¹‰åŒ–æäº¤è§„èŒƒå‚è€ƒ*__](https://www.conventionalcommits.org/)

      - name: Delete resolved title comment
        if: steps.semantic-check.outcome == 'success' && steps.find-title-comment.outputs.comment-id != ''
        uses: detomarco/delete-comment@main
        with:
          comment-id: ${{ steps.find-title-comment.outputs.comment-id }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add label
        if: steps.semantic-check.outcome == 'failure' || steps.branch.outputs.head_ref_branch == 'main'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: invalid

      - name: Fail job if checks failed
        if: steps.branch.outputs.head_ref_branch == 'main' || steps.semantic-check.outcome == 'failure'
        run: |
          if [[ "${{ steps.branch.outputs.head_ref_branch }}" == "main" ]]; then
            echo "- åˆ†æ”¯æ£€æŸ¥å¤±è´¥: PR æ¥è‡ª main åˆ†æ”¯"
          fi
          if [[ "${{ steps.semantic-check.outcome }}" == "failure" ]]; then
            echo "- æ ‡é¢˜æ£€æŸ¥å¤±è´¥: PR æ ‡é¢˜æ ¼å¼ä¸è§„èŒƒ"
          fi
          exit 1
